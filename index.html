<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECãƒ¢ãƒ¼ãƒ«å•†å“åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=IBM+Plex+Mono:wght@400;600&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #0F172A; --secondary: #1E293B; --accent: #06B6D4;
            --accent-hover: #0891B2; --success: #10B981; --warning: #F59E0B;
            --danger: #EF4444; --bg: #F8FAFC; --card: #FFFFFF;
            --border: #E2E8F0; --text: #0F172A; --text-muted: #64748B;
            --rakuten: #BF0000; --yahoo: #0050CC; --amazon: #FF9900;
        }
        body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        header { background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; padding: 2rem; margin-bottom: 2rem; border-radius: 16px; box-shadow: 0 20px 60px rgba(15, 23, 42, 0.15); position: relative; }
        h1 { font-size: 2.5rem; font-weight: 900; letter-spacing: -0.02em; margin-bottom: 0.5rem; }
        .subtitle { color: #CBD5E1; font-size: 1.1rem; }
        .google-drive-status { position: absolute; top: 2rem; right: 2rem; display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem; }
        .sync-status { padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.875rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .sync-status.connected { background: rgba(16, 185, 129, 0.2); color: #10B981; }
        .sync-status.disconnected { background: rgba(100, 116, 139, 0.2); color: #CBD5E1; }
        .user-info { font-size: 0.75rem; color: #CBD5E1; }
        .google-btn { padding: 0.75rem 1.5rem; background: white; color: var(--primary); border: none; border-radius: 8px; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .google-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .upload-section { background: var(--card); padding: 2.5rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border: 2px dashed var(--border); }
        .mall-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .mall-option { padding: 1.5rem; border: 3px solid var(--border); border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.3s ease; background: white; }
        .mall-option:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        .mall-option.selected { border-color: var(--accent); background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(6, 182, 212, 0.05) 100%); }
        .mall-option.rakuten.selected { border-color: var(--rakuten); background: linear-gradient(135deg, rgba(191, 0, 0, 0.1) 0%, rgba(191, 0, 0, 0.05) 100%); }
        .mall-option.yahoo.selected { border-color: var(--yahoo); background: linear-gradient(135deg, rgba(0, 80, 204, 0.1) 0%, rgba(0, 80, 204, 0.05) 100%); }
        .mall-option.amazon.selected { border-color: var(--amazon); background: linear-gradient(135deg, rgba(255, 153, 0, 0.1) 0%, rgba(255, 153, 0, 0.05) 100%); }
        .btn { display: inline-block; padding: 0.875rem 2rem; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3); }
        .btn:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--secondary); }
        .btn-success { background: var(--success); }
        .nav-tabs { display: flex; gap: 0.5rem; margin-bottom: 2rem; background: var(--card); padding: 0.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        .nav-tab { flex: 1; padding: 1rem; background: transparent; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; text-align: center; font-weight: 600; font-size: 1rem; color: var(--text-muted); }
        .nav-tab.active { background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%); color: white; box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: var(--card); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        .card-title { font-size: 0.875rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 0.5rem; }
        .card-value { font-size: 2rem; font-weight: 900; font-family: 'IBM Plex Mono', monospace; color: var(--primary); }
        .data-table { background: var(--card); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); margin-bottom: 2rem; }
        .table-header { padding: 1.5rem; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--bg); }
        th { padding: 1rem; text-align: left; font-weight: 600; font-size: 0.875rem; color: var(--text-muted); text-transform: uppercase; border-bottom: 2px solid var(--border); }
        td { padding: 1rem; border-bottom: 1px solid var(--border); }
        tbody tr:hover { background: rgba(6, 182, 212, 0.05); }
        .mall-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .mall-badge.æ¥½å¤© { background: rgba(191, 0, 0, 0.1); color: var(--rakuten); }
        .mall-badge.Yahoo { background: rgba(0, 80, 204, 0.1); color: var(--yahoo); }
        .mall-badge.Amazon { background: rgba(255, 153, 0, 0.1); color: var(--amazon); }
        .success-box { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border-left: 4px solid var(--success); padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .success-box h4 { color: var(--success); margin-bottom: 0.5rem; }
        .info-box { background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(6, 182, 212, 0.05) 100%); border-left: 4px solid var(--accent); padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .info-box h4 { color: var(--accent); margin-bottom: 0.5rem; }
        .warning-box { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); border-left: 4px solid var(--warning); padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .warning-box h4 { color: var(--warning); margin-bottom: 0.5rem; }
        .search-section { background: var(--card); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        .search-input, select, input[type="date"], textarea { width: 100%; padding: 1rem 1.5rem; font-size: 1rem; border: 2px solid var(--border); border-radius: 12px; transition: all 0.3s ease; font-family: 'Noto Sans JP', sans-serif; }
        .search-input:focus, select:focus, input[type="date"]:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.1); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text); }
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.3; }
        .notification { position: fixed; top: 2rem; right: 2rem; padding: 1rem 1.5rem; background: var(--card); border-radius: 12px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15); border-left: 4px solid var(--success); display: none; z-index: 1000; max-width: 400px; }
        .notification.show { display: block; animation: slideIn 0.3s ease; }
        .notification.error { border-left-color: var(--danger); }
        @keyframes s
        lideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        input[type="file"] { display: none; }
        .chart-container { background: var(--card); padding: 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        .view-content { display: none; }
        .view-content.active { display: block; }
        .btn-group { display: flex; gap: 0.5rem; background: var(--bg); padding: 0.5rem; border-radius: 8px; }
        .btn-group .btn { flex: 1; padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-group .btn.active { background: var(--accent); }
        .delete-btn { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.2rem; padding: 0.5rem; transition: all 0.2s ease; }
        .delete-btn:hover { transform: scale(1.2); }
        .modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0, 0, 0, 0.5); 
            z-index: 2000; 
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.show { 
            display: flex !important;
        }
        .modal { 
            background: var(--card); 
            border-radius: 16px; 
            padding: 2rem; 
            max-width: 500px; 
            width: 90%; 
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); 
            animation: slideUp 0.3s ease; 
        }
        @keyframes slideUp { 
            from { transform: translateY(50px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        .modal-title { 
            font-size: 1.5rem; 
            font-weight: 700; 
            margin-bottom: 1rem; 
            color: var(--text); 
        }
        .modal-content { 
            color: var(--text-muted); 
            margin-bottom: 2rem; 
            line-height: 1.6; 
        }
        .modal-buttons { 
            display: flex; 
            gap: 1rem; 
            justify-content: flex-end; 
        }
        .modal-buttons .btn { 
            flex: 1; 
        }
        /* æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .period-filter {
            background: var(--bg);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }
        .period-filter-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text);
        }
        .period-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .period-btn {
            padding: 0.625rem 1.25rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .period-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        .period-btn.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }
        .custom-date-inputs {
            display: none;
            gap: 0.75rem;
            align-items: center;
            margin-left: 1rem;
        }
        .custom-date-inputs.show {
            display: flex;
        }
        .custom-date-inputs input[type="date"] {
            padding: 0.5rem 0.75rem;
            width: auto;
        }
        .custom-date-inputs .date-separator {
            color: var(--text-muted);
            font-weight: 500;
        }
        .period-display {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            background: rgba(6, 182, 212, 0.1);
            border-radius: 6px;
            display: inline-block;
        }
        @media (max-width: 768px) {
            .period-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            .custom-date-inputs {
                margin-left: 0;
                margin-top: 0.75rem;
                flex-direction: column;
            }
            .custom-date-inputs.show {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š ECãƒ¢ãƒ¼ãƒ«å•†å“åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p class="subtitle">æ¥½å¤©ãƒ»Yahooãƒ»Amazon çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–å¯¾å¿œï¼‰</p>
            <div class="google-drive-status">
                <div class="sync-status disconnected" id="syncStatus">
                    <span>â˜ï¸</span>
                    <span id="syncStatusText">æœªæ¥ç¶š</span>
                </div>
                <div class="user-info" id="userInfo"></div>
                <button class="google-btn" onclick="openSettingsModal()" title="è¨­å®š">
                    <span>âš™ï¸</span>
                    <span>è¨­å®š</span>
                </button>
                <button class="google-btn" id="reloadDataBtn" onclick="reloadDataFromSpreadsheet()" style="display: none;">
                    <span>ğŸ”„</span>
                    <span>ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿</span>
                </button>
                <button class="google-btn" id="googleSignInBtn" onclick="handleAuthClick()">
                    <span>ğŸ”</span>
                    <span>Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æº</span>
                </button>
                <button class="google-btn" id="googleSignOutBtn" onclick="handleSignoutClick()" style="display: none;">
                    <span>ğŸ”“</span>
                    <span>é€£æºè§£é™¤</span>
                </button>
            </div>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">ğŸ“ˆ æ¦‚è¦</button>
            <button class="nav-tab" onclick="switchTab('trend')">ğŸ“‰ æ—¥æ¬¡æ¨ç§»åˆ†æ</button>
            <button class="nav-tab" onclick="switchTab('actions')">ğŸ“ æ–½ç­–è¨˜éŒ²</button>
        </div>

        <div id="tab-overview" class="tab-content active">
            <div class="upload-section">
                <h3 style="margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                <div class="success-box">
                    <h4>âœ… å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–å¯¾å¿œ</h4>
                    <p style="line-height: 1.8;">å¾“æ¥­å“¡ï¼ˆ<strong id="exampleUserEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="305859425f40425f0001020370575d51595c1e535f5d">[email&#160;protected]</a></strong>ï¼‰ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸCSVãƒ‡ãƒ¼ã‚¿ã‚‚ã€<br><strong>ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong>ã§è‡ªå‹•çš„ã«ç¢ºèªã§ãã¾ã™ã€‚</p>
                </div>
                <div class="info-box">
                    <h4>ğŸ“Œ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ‰‹é †</h4>
                    <ol style="margin-left: 1.5rem; line-height: 1.8;">
                        <li><strong>åˆå›ã®ã¿:</strong> å³ä¸Šã®ã€ŒGoogleãƒ‰ãƒ©ã‚¤ãƒ–é€£æºã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li>ä¸‹ã®ãƒ¢ãƒ¼ãƒ«é¸æŠãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ¢ãƒ¼ãƒ«ã‚’é¸æŠ</li>
                        <li>è©²å½“ãƒ¢ãƒ¼ãƒ«ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
                        <li>è‡ªå‹•çš„ã«å…±æœ‰Googleãƒ‰ãƒ©ã‚¤ãƒ–ã«ä¿å­˜</li>
                    </ol>
                </div>
                <div class="warning-box">
                    <h4>âš ï¸ é‡è¦</h4>
                    <ul style="margin-left: 1.5rem; line-height: 1.8;">
                        <li><strong>æ¥½å¤©:</strong> 1æ—¥å˜ä½ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å¯¾å¿œï¼ˆæ—¥ä»˜ã¯è‡ªå‹•æŠ½å‡ºï¼‰</li>
                        <li><strong>Yahooãƒ»Amazon:</strong> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</li>
                        <li><strong>â˜ï¸ è‡ªå‹•åŒæœŸ:</strong> ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã«ä¿å­˜ã•ã‚Œã¾ã™</li>
                    </ul>
                </div>
                <div class="mall-selector">
                    <div class="mall-option rakuten" onclick="selectMall('rakuten')">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">ğŸ”´</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">æ¥½å¤©</div>
                    </div>
                    <div class="mall-option yahoo" onclick="selectMall('yahoo')">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">ğŸ”µ</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">Yahoo</div>
                    </div>
                    <div class="mall-option amazon" onclick="selectMall('amazon')">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">ğŸŸ </div>
                        <div style="font-size: 1.25rem; font-weight: 700;">Amazon</div>
                    </div>
                </div>
                <div id="dateInputSection" style="display: none; margin-bottom: 2rem;">
                    <div class="form-group">
                        <label class="form-label">ğŸ“… ãƒ‡ãƒ¼ã‚¿ã®æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
                        <input type="date" id="uploadDate" class="search-input">
                    </div>
                </div>
                <div style="text-align: center; padding: 3rem; border: 2px dashed var(--border); border-radius: 12px; cursor: pointer;" onclick="document.getElementById('csvFile').click()">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ“¤</div>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem;" id="uploadInstruction">ã¾ãšå³ä¸Šã®ã€ŒGoogleãƒ‰ãƒ©ã‚¤ãƒ–é€£æºã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                    <input type="file" id="csvFile" accept=".csv" multiple disabled>
                    <button class="btn" id="uploadBtn" disabled>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                </div>
            </div>
            <div class="dashboard" id="dashboard">
                <div class="card">
                    <div class="card-title">ç·ã‚¢ã‚¯ã‚»ã‚¹æ•°</div>
                    <div class="card-value" id="totalAccess">0</div>
                </div>
                <div class="card">
                    <div class="card-title">ç·å£²ä¸Š</div>
                    <div class="card-value" id="totalSales">Â¥0</div>
                </div>
                <div class="card">
                    <div class="card-title">ç·æ³¨æ–‡æ•°</div>
                    <div class="card-value" id="totalOrders">0</div>
                </div>
                <div class="card">
                    <div class="card-title">å¹³å‡CVR</div>
                    <div class="card-value" id="avgCVR">0.00%</div>
                </div>
            </div>
            <div class="data-table">
                <div class="table-header">
                    <h2>å•†å“ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h2>
                </div>
                <div style="overflow-x: auto;">
                    <table id="dataTable">
 <thead>
    <tr>
        <th>å®Ÿæ–½æ—¥</th><th>ãƒ¢ãƒ¼ãƒ«</th><th>SKU</th>
        <th>å•†å“å</th><th>ã‚¢ã‚¯ã‚»ã‚¹æ•°</th><th>å£²ä¸Š</th><th>æ³¨æ–‡æ•°</th><th>CVR</th>
    </tr>
</thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="8" class="empty-state">
                                    <div class="empty-state-icon">ğŸ“‚</div>
                                    <p>å³ä¸Šã®ã€ŒGoogleãƒ‰ãƒ©ã‚¤ãƒ–é€£æºã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

<div id="tab-trend" class="tab-content">
            <div class="search-section">
                <h2 style="margin-bottom: 1.5rem;">ğŸ” æ—¥æ¬¡æ¨ç§»åˆ†æ</h2>
                
                <!-- æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="period-filter">
                    <label class="period-filter-label">ğŸ“… è¡¨ç¤ºæœŸé–“</label>
                    <div class="period-buttons">
                        <button class="period-btn active" data-period="thisMonth" onclick="setPeriodFilter('thisMonth', this)">ä»Šæœˆ</button>
                        <button class="period-btn" data-period="last2Months" onclick="setPeriodFilter('last2Months', this)">éå»2ãƒ¶æœˆ</button>
                        <button class="period-btn" data-period="custom" onclick="setPeriodFilter('custom', this)">ã‚«ã‚¹ã‚¿ãƒ </button>
                        <div class="custom-date-inputs" id="customDateInputs">
                            <input type="date" id="filterStartDate">
                            <span class="date-separator">ã€œ</span>
                            <input type="date" id="filterEndDate">
                            <button class="btn" onclick="applyCustomDateFilter()" style="padding: 0.5rem 1rem;">é©ç”¨</button>
                        </div>
                    </div>
                    <div class="period-display" id="periodDisplay">è¡¨ç¤ºæœŸé–“: ä»Šæœˆ</div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">SKU</label>
                        <input type="text" id="trendSKU" class="search-input" placeholder="ä¾‹: 213-62">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ãƒ¢ãƒ¼ãƒ«</label>
                        <select id="trendMall" class="search-input">
                            <option value="æ¥½å¤©">æ¥½å¤©</option>
                            <option value="Yahoo">Yahoo</option>
                            <option value="Amazon">Amazon</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="loadTrendData()">ğŸ“Š æ¨ç§»ã‚’è¡¨ç¤º</button>
            </div>

            <div class="chart-container" id="viewToggleContainer" style="display: none;">
                <div class="btn-group">
                    <button class="btn active" onclick="switchView('chart')">ğŸ“Š ã‚°ãƒ©ãƒ•è¡¨ç¤º</button>
                    <button class="btn" onclick="switchView('table')">ğŸ“‹ è¡¨å½¢å¼è¡¨ç¤º</button>
                </div>
            </div>

            <div id="productActions" style="display: none;"></div>

            <div id="chartView" class="view-content active">
                <div class="chart-container" id="chartContainer" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 id="chartProductName" style="font-size: 1.5rem; font-weight: 700;">å•†å“å</h3>
                    </div>
                    <canvas id="salesChart" height="80"></canvas>
                </div>

                <div class="chart-container" id="chartContainer2" style="display: none;">
                    <canvas id="cvrChart" height="80"></canvas>
                </div>

                <div class="chart-container" id="chartContainer3" style="display: none;">
                    <canvas id="accessChart" height="80"></canvas>
                </div>
            </div>

            <div id="tableView" class="view-content">
                <div class="data-table" id="trendTableContainer" style="display: none;">
                    <div class="table-header">
                        <h2 id="trendTableTitle">æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿</h2>
                        <button class="btn btn-secondary" onclick="exportTrendData()">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>æ—¥ä»˜</th>
                                    <th>ã‚¢ã‚¯ã‚»ã‚¹æ•°</th>
                                    <th>å£²ä¸Š</th>
                                    <th>æ³¨æ–‡æ•°</th>
                                    <th>CVR(%)</th>
                                    <th>å®¢å˜ä¾¡</th>
                                </tr>
                            </thead>
                            <tbody id="trendTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div id="tab-actions" class="tab-content">
            <div class="search-section">
                <h2 style="margin-bottom: 1.5rem;">ğŸ“ æ–½ç­–è¨˜éŒ²</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">å®Ÿæ–½æ—¥</label>
                        <input type="date" id="actionDate" class="search-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ãƒ¢ãƒ¼ãƒ«</label>
                        <select id="actionMall" class="search-input">
                            <option value="æ¥½å¤©">æ¥½å¤©</option>
                            <option value="Yahoo">Yahoo</option>
                            <option value="Amazon">Amazon</option>
                            <option value="å…¨ã‚µã‚¤ãƒˆ">å…¨ã‚µã‚¤ãƒˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SKU</label>
                        <input type="text" id="actionSKU" class="search-input" placeholder="ä¾‹: 213-62">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">æ–½ç­–ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="actionCategory" class="search-input">
                        <option value="ç”»åƒæ”¹å–„">ç”»åƒæ”¹å–„</option>
                        <option value="ãƒšãƒ¼ã‚¸æ”¹å–„">ãƒšãƒ¼ã‚¸æ”¹å–„</option>
                        <option value="SEOå¯¾ç­–">SEOå¯¾ç­–</option>
                        <option value="ä¾¡æ ¼èª¿æ•´">ä¾¡æ ¼èª¿æ•´</option>
                        <option value="åºƒå‘Šæ–½ç­–">åºƒå‘Šæ–½ç­–</option>
                        <option value="åœ¨åº«èª¿æ•´">åœ¨åº«èª¿æ•´</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æ–½ç­–å†…å®¹</label>
                    <textarea id="actionContent" class="search-input" rows="3" placeholder="å…·ä½“çš„ãªæ–½ç­–å†…å®¹ã‚’è¨˜å…¥"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">æœŸå¾…åŠ¹æœ</label>
                    <input type="text" id="actionExpected" class="search-input" placeholder="ä¾‹: CVR 0.5%å‘ä¸Š">
                </div>
                <button class="btn btn-success" onclick="addAction()">ğŸ’¾ æ–½ç­–ã‚’è¨˜éŒ²</button>
            </div>
            <div class="data-table">
                <div class="table-header">
                    <h2>æ–½ç­–è¨˜éŒ²ä¸€è¦§</h2>
                </div>
                <div style="overflow-x: auto;">
                    <table id="actionsTable">
                        <thead>
                            <tr>
                                <th>å®Ÿæ–½æ—¥</th><th>ãƒ¢ãƒ¼ãƒ«</th><th>SKU</th>
                                <th>ã‚«ãƒ†ã‚´ãƒª</th><th>æ–½ç­–å†…å®¹</th><th>æœŸå¾…åŠ¹æœ</th><th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="actionsTableBody">
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <div class="empty-state-icon">ğŸ“‹</div>
                                    <p>æ–½ç­–ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="notification" id="notification"></div>
    
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// --- localStorage ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿ ---
function getConfig() {
    const config = localStorage.getItem('ec_dashboard_config');
    if (config) {
        return JSON.parse(config);
    }
    return null;
}

function saveConfig(apiKey, clientId, spreadsheetId) {
    const config = {
        API_KEY: apiKey,
        CLIENT_ID: clientId,
        SPREADSHEET_ID: spreadsheetId
    };
    localStorage.setItem('ec_dashboard_config', JSON.stringify(config));
    return config;
}

function clearConfig() {
    localStorage.removeItem('ec_dashboard_config');
}

// è¨­å®šã‚’å–å¾—
let configData = getConfig();
let CLIENT_ID = configData ? configData.CLIENT_ID : '';
let API_KEY = configData ? configData.API_KEY : '';
let SPREADSHEET_ID = configData ? configData.SPREADSHEET_ID : '';

const DISCOVERY_DOCS = [
    "https://sheets.googleapis.com/$discovery/rest?version=v4"
];
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

const SHEET_NAME_ACTIONS = 'æ–½ç­–è¨˜éŒ²';
const DATA_FILE_NAME = 'ec_analysis_data.json';
const SHARED_DRIVE_ID = '';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let driveFileId = null;
        let currentUserEmail = '';
        let dailyData = [];
        let actionsData = [];
        let uploadHistory = [];
        let selectedMall = null;
        let salesChart, cvrChart, accessChart;
        let currentTrendData = [];
        let currentProductName = '';
        let currentSKU = '';
        let currentMall = '';
        let currentView = 'chart';

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            if (!API_KEY) {
                console.log('Google API Key not configured');
                return;
            }
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            if (!CLIENT_ID) {
                console.log('Google Client ID not configured');
                return;
            }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited && CLIENT_ID && API_KEY) {
                document.getElementById('googleSignInBtn').disabled = false;
            }
        }

        function handleAuthClick() {
            if (!CLIENT_ID || !API_KEY) {
                showNotification('âš ï¸ Google APIè¨­å®šãŒå¿…è¦ã§ã™', true);
                return;
            }
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                
                const token = gapi.client.getToken();
                if (token && token.access_token) {
                    try {
                        const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                            headers: {
                                'Authorization': `Bearer ${token.access_token}`
                            }
                        });
                        const userInfo = await response.json();
                        currentUserEmail = userInfo.email || 'unknown@example.com';
                    } catch (err) {
                        console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
                        currentUserEmail = 'user@example.com';
                    }
                } else {
                    currentUserEmail = 'user@example.com';
                }
                
                document.getElementById('googleSignInBtn').style.display = 'none';
                document.getElementById('googleSignOutBtn').style.display = 'block';
                document.getElementById('reloadDataBtn').style.display = 'block';
                document.getElementById('syncStatus').classList.remove('disconnected');
                document.getElementById('syncStatus').classList.add('connected');
                document.getElementById('syncStatusText').textContent = 'æ¥ç¶šæ¸ˆã¿';
                document.getElementById('userInfo').textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${currentUserEmail}`;
                document.getElementById('csvFile').disabled = false;
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadInstruction').textContent = 'ãƒ¢ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„';
                
                showNotification('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ¥ç¶šã—ã¾ã—ãŸ');
                // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                await loadDataFromSpreadsheet();
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('googleSignInBtn').style.display = 'block';
                document.getElementById('googleSignOutBtn').style.display = 'none';
                document.getElementById('syncStatus').classList.remove('connected');
                document.getElementById('syncStatus').classList.add('disconnected');
                document.getElementById('syncStatusText').textContent = 'æœªæ¥ç¶š';
                document.getElementById('userInfo').textContent = '';
                driveFileId = null;
                currentUserEmail = '';
                showNotification('âœ… Googleãƒ‰ãƒ©ã‚¤ãƒ–ã‹ã‚‰åˆ‡æ–­ã—ã¾ã—ãŸ');
            }
        }

        async function findOrCreateDataFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${DATA_FILE_NAME}' and '${SHARED_DRIVE_ID}' in parents and trashed=false`,
                    corpora: 'drive',
                    driveId: SHARED_DRIVE_ID,
                    includeItemsFromAllDrives: true,
                    supportsAllDrives: true,
                    fields: 'files(id, name)',
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    driveFileId = files[0].id;
                    console.log('æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹:', driveFileId);
                } else {
                    const initialData = {
                        dailyData: [],
                        actions: [],
                        uploadHistory: [],
                        lastSync: new Date().toISOString()
                    };
                    const file = new Blob([JSON.stringify(initialData, null, 2)], {type: 'application/json'});
                    const metadata = {
                        name: DATA_FILE_NAME,
                        mimeType: 'application/json',
                        parents: [SHARED_DRIVE_ID]
                    };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                    form.append('file', file);
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&supportsAllDrives=true', {
                        method: 'POST',
                        headers: new Headers({'Authorization': 'Bearer ' + gapi.client.getToken().access_token}),
                        body: form
                    });
                    const result = await response.json();
                    driveFileId = result.id;
                    console.log('æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ:', driveFileId);
                }
            } catch (err) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢/ä½œæˆã‚¨ãƒ©ãƒ¼:', err);
                showNotification('âŒ å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            }
        }

        async function loadFromGoogleDrive() {
            if (!driveFileId) return;
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: driveFileId,
                    alt: 'media',
                    supportsAllDrives: true
                });
                const cloudData = JSON.parse(response.body);
                dailyData = cloudData.dailyData || [];
                actionsData = cloudData.actions || [];
                uploadHistory = cloudData.uploadHistory || [];
                updateDashboard();
                updateTable();
                updateActionsTable();
                showNotification('âœ… å…±æœ‰ãƒ‰ãƒ©ã‚¤ãƒ–ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
            } catch (err) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                showNotification('âš ï¸ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            }
        }

        async function syncToGoogleDrive() {
            if (!driveFileId) return;
            try {
                const data = {
                    dailyData: dailyData,
                    actions: actionsData,
                    uploadHistory: uploadHistory,
                    lastSync: new Date().toISOString(),
                    lastSyncBy: currentUserEmail
                };
                const response = await gapi.client.request({
                    path: `/upload/drive/v3/files/${driveFileId}?supportsAllDrives=true`,
                    method: 'PATCH',
                    params: {
                        uploadType: 'media'
                    },
                    body: JSON.stringify(data)
                });
                console.log('ãƒ‡ãƒ¼ã‚¿åŒæœŸå®Œäº†:', new Date().toLocaleString(), 'by', currentUserEmail);
                const statusText = document.getElementById('syncStatusText');
                const originalText = statusText.textContent;
                statusText.textContent = 'åŒæœŸå®Œäº† âœ“';
                setTimeout(() => {
                    statusText.textContent = originalText;
                }, 2000);
            } catch (err) {
                console.error('ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚¨ãƒ©ãƒ¼:', err);
                showNotification('âš ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            }
        }

        async function autoSync() {
            // Googleãƒ‰ãƒ©ã‚¤ãƒ–åŒæœŸã¯ç„¡åŠ¹åŒ– - ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã¿ä½¿ç”¨
            return;
        }
        
        async function loadDataFromSpreadsheet() {
            try {
                const mallSheets = [
                    { name: 'æ¥½å¤©ãƒ‡ãƒ¼ã‚¿', mall: 'æ¥½å¤©' },
                    { name: 'Yahooãƒ‡ãƒ¼ã‚¿', mall: 'Yahoo' },
                    { name: 'Amazonãƒ‡ãƒ¼ã‚¿', mall: 'Amazon' }
                ];
                
                dailyData = [];
                actionsData = [];
                let totalLoaded = 0;
                let actionsLoaded = 0;
                
                // å„ãƒ¢ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                for (const sheet of mallSheets) {
                    try {
                        const response = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: SPREADSHEET_ID,
                            range: `${sheet.name}!A2:I` // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                        });
                        
                        const rows = response.result.values || [];
                        
                        for (const row of rows) {
                            if (row.length >= 8) {
                                dailyData.push({
                                    date: row[0] || '',
                                    sku: row[1] || '',
                                    name: row[2] || '',
                                    access: parseInt(row[3] || 0),
                                    sales: parseInt(row[4] || 0),
                                    orders: parseInt(row[5] || 0),
                                    cvr: parseFloat(row[6] || 0),
                                    unitPrice: parseInt(row[7] || 0),
                                    mall: sheet.mall
                                });
                            }
                        }
                        
                        totalLoaded += rows.length;
                    } catch (err) {
                        // ã‚·ãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                        console.log(`${sheet.name}ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:`, err);
                    }
                }
                
                // æ–½ç­–è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿
                try {
                    const actionsResponse = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: `${SHEET_NAME_ACTIONS}!A2:H` // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
                    });
                    
                    const actionsRows = actionsResponse.result.values || [];
                    
                    for (const row of actionsRows) {
                        if (row.length >= 6) {
                            actionsData.push({
                                date: row[0] || '',
                                mall: row[1] || '',
                                sku: row[2] || '',
                                category: row[3] || '',
                                content: row[4] || '',
                                expected: row[5] || '',
                                createdBy: row[6] || '',
                                id: Date.now() + Math.random()
                            });
                        }
                    }
                    
                    actionsLoaded = actionsRows.length;
                } catch (err) {
                    console.log('æ–½ç­–è¨˜éŒ²ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', err);
                }
                
                updateDashboard();
                updateTable();
                updateActionsTable();
                
                if (totalLoaded > 0 || actionsLoaded > 0) {
                    showNotification(`âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å•†å“ãƒ‡ãƒ¼ã‚¿${totalLoaded}ä»¶ã€æ–½ç­–è¨˜éŒ²${actionsLoaded}ä»¶ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                } else {
                    showNotification('â„¹ï¸ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                }
            } catch (err) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                showNotification('âš ï¸ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            }
        }
        
        async function reloadDataFromSpreadsheet() {
            showNotification('ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ä¸­...');
            await loadDataFromSpreadsheet();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.view-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${view}View`).classList.add('active');
        }

        function selectMall(mall) {
            if (!gapi.client.getToken()) {
                showNotification('âš ï¸ å…ˆã«ã€ŒGoogleãƒ‰ãƒ©ã‚¤ãƒ–é€£æºã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„', true);
                return;
            }
            selectedMall = mall;
            document.querySelectorAll('.mall-option').forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.mall-option').classList.add('selected');
            document.getElementById('csvFile').disabled = false;
            document.getElementById('uploadBtn').disabled = false;
            const mallNames = {'rakuten': 'æ¥½å¤©', 'yahoo': 'Yahoo', 'amazon': 'Amazon'};
            const dateInputSection = document.getElementById('dateInputSection');
            if (mall === 'yahoo' || mall === 'amazon') {
                dateInputSection.style.display = 'block';
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('uploadDate').value = today;
            } else {
                dateInputSection.style.display = 'none';
            }
            document.getElementById('uploadInstruction').textContent = `${mallNames[mall]}ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—`;
            showNotification(`${mallNames[mall]}ã‚’é¸æŠã—ã¾ã—ãŸ`);
        }

        document.getElementById('csvFile').addEventListener('change', function(e) {
            if (!selectedMall) {
                showNotification('ãƒ¢ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', true);
                return;
            }
            if (!gapi.client.getToken()) {
                showNotification('âš ï¸ å…ˆã«Googleãƒ‰ãƒ©ã‚¤ãƒ–é€£æºã‚’ã—ã¦ãã ã•ã„', true);
                return;
            }
            const files = e.target.files;
            for (let file of files) {
                processCSV(file, selectedMall);
            }
            e.target.value = '';
        });

        async function processCSV(file, mall) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                let addedCount = 0;
                let parsedData = [];
                let dateStr = '';
                
                switch(mall) {
                    case 'rakuten':
                        const rakutenResult = parseRakutenCSV(text, file.name);
                        addedCount = rakutenResult.count;
                        parsedData = rakutenResult.data;
                        dateStr = rakutenResult.date;
                        break;
                    case 'yahoo':
                        const yahooResult = parseYahooCSV(text, file.name);
                        addedCount = yahooResult.count;
                        parsedData = yahooResult.data;
                        dateStr = yahooResult.date;
                        break;
                    case 'amazon':
                        const amazonResult = parseAmazonCSV(text, file.name);
                        addedCount = amazonResult.count;
                        parsedData = amazonResult.data;
                        dateStr = amazonResult.date;
                        break;
                }
                
                if (addedCount > 0) {
                    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜
                    await saveToSpreadsheet(parsedData, mall);
                    
                    uploadHistory.push({
                        uploadDate: new Date().toISOString(),
                        uploadBy: currentUserEmail,
                        fileName: file.name,
                        mall: mall,
                        recordCount: addedCount
                    });
                    updateDashboard();
                    updateTable();
                    await autoSync();
                }
            };
            if (mall === 'yahoo') {
                reader.readAsText(file, 'Shift-JIS');
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        }
        
        async function saveToSpreadsheet(data, mall) {
            try {
                const mallNames = {
                    'rakuten': 'æ¥½å¤©ãƒ‡ãƒ¼ã‚¿',
                    'yahoo': 'Yahooãƒ‡ãƒ¼ã‚¿',
                    'amazon': 'Amazonãƒ‡ãƒ¼ã‚¿'
                };
                const sheetName = mallNames[mall];
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
                const rows = data.map(item => [
                    item.date,
                    item.sku,
                    item.name,
                    item.access,
                    item.sales,
                    item.orders,
                    item.cvr,
                    item.unitPrice,
                    new Date().toISOString()
                ]);
                
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${sheetName}!A:I`,
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: rows
                    }
                });
                
                showNotification(`âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã€Œ${sheetName}ã€ã«${rows.length}ä»¶ä¿å­˜ã—ã¾ã—ãŸ`);
            } catch (err) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', err);
                showNotification('âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            }
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim().replace(/^"|"$/g, ''));
            return values;
        }

        function parseRakutenCSV(csvText, filename) {
            const lines = csvText.split('\n');
            let headerIndex = 5;
            const headers = lines[headerIndex].split(',').map(h => h.trim().replace(/"/g, ''));
            let dateStr = null;
            if (lines.length > 2) {
                const periodLine = lines[2];
                const dayPattern = /(\d{4})å¹´(\d{2})æœˆ(\d{2})æ—¥ã‹ã‚‰(\d{4})å¹´(\d{2})æœˆ(\d{2})æ—¥/;
                const dayMatch = periodLine.match(dayPattern);
                if (dayMatch) {
                    const startDate = `${dayMatch[1]}-${dayMatch[2]}-${dayMatch[3]}`;
                    const endDate = `${dayMatch[4]}-${dayMatch[5]}-${dayMatch[6]}`;
                    if (startDate === endDate) {
                        dateStr = startDate;
                    } else {
                        showNotification(`âš ï¸ ã‚¹ã‚­ãƒƒãƒ—: è¤‡æ•°æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã¯å–ã‚Šè¾¼ã‚ã¾ã›ã‚“`, true);
                        return { count: 0, data: [], date: '' };
                    }
                }
            }
            if (!dateStr) {
                showNotification('âš ï¸ æ—¥ä»˜ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ', true);
                return { count: 0, data: [], date: '' };
            }
            let addedCount = 0;
            const parsedData = [];
            for (let i = headerIndex + 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = parseCSVLine(lines[i]);
                if (values.length < headers.length) continue;
                const product = {};
                headers.forEach((header, index) => {
                    product[header] = values[index];
                });
                const formattedProduct = {
                    date: dateStr,
                    mall: 'æ¥½å¤©',
                    sku: product['å•†å“ç®¡ç†ç•ªå·'] || '',
                    name: product['å•†å“å'] || '',
                    access: parseInt(product['ã‚¢ã‚¯ã‚»ã‚¹äººæ•°'] || 0),
                    sales: parseInt(product['å£²ä¸Š'] || 0),
                    orders: parseInt(product['å£²ä¸Šä»¶æ•°'] || 0),
                    cvr: parseFloat(product['è»¢æ›ç‡']?.replace('%', '') || 0),
                    unitPrice: parseInt(product['å®¢å˜ä¾¡'] || 0)
                };
                dailyData.push(formattedProduct);
                parsedData.push(formattedProduct);
                addedCount++;
            }
            showNotification(`âœ… ${addedCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆæ—¥ä»˜: ${dateStr}ï¼‰`);
            return { count: addedCount, data: parsedData, date: dateStr };
        }

        function parseYahooCSV(csvText, filename) {
            const dateInput = document.getElementById('uploadDate').value;
            if (!dateInput) {
                showNotification('âš ï¸ æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return { count: 0, data: [], date: '' };
            }
            const dateStr = dateInput;
            const lines = csvText.split('\n');
            const headers = parseCSVLine(lines[0]);
            const aggregated = {};
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = parseCSVLine(lines[i]);
                if (values.length < headers.length) continue;
                const name = values[0] || '';
                const productCode = values[1] || '';
                const sales = parseInt(values[3] || 0);
                const orderCount = parseInt(values[4] || 0);
                const visitors = parseInt(values[12] || 0);
                if (!productCode) continue;
                const key = productCode;
                if (!aggregated[key]) {
                    aggregated[key] = {
                        name: name,
                        sku: productCode,
                        sales: 0,
                        orders: 0,
                        visitors: 0
                    };
                }
                aggregated[key].sales += sales;
                aggregated[key].orders += orderCount;
                aggregated[key].visitors = Math.max(aggregated[key].visitors, visitors);
            }
            let addedCount = 0;
            const parsedData = [];
            for (const key in aggregated) {
                const item = aggregated[key];
                const cvr = item.visitors > 0 ? (item.orders / item.visitors * 100) : 0;
                const unitPrice = item.orders > 0 ? (item.sales / item.orders) : 0;
                const formattedProduct = {
                    date: dateStr,
                    mall: 'Yahoo',
                    sku: item.sku,
                    name: item.name,
                    access: item.visitors,
                    sales: item.sales,
                    orders: item.orders,
                    cvr: cvr,
                    unitPrice: unitPrice
                };
                dailyData.push(formattedProduct);
                parsedData.push(formattedProduct);
                addedCount++;
            }
            showNotification(`âœ… ${addedCount}ä»¶ã®å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆæ—¥ä»˜: ${dateStr}ï¼‰`);
            return { count: addedCount, data: parsedData, date: dateStr };
        }

        function parseAmazonCSV(csvText, filename) {
            const dateInput = document.getElementById('uploadDate').value;
            if (!dateInput) {
                showNotification('âš ï¸ æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return { count: 0, data: [], date: '' };
            }
            const dateStr = dateInput;
            const lines = csvText.split('\n');
            if (lines.length < 2) {
                showNotification('âš ï¸ CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™', true);
                return { count: 0, data: [], date: '' };
            }
            const headers = parseCSVLine(lines[0]);
            const asinIndex = headers.findIndex(h => h.includes('ASIN'));
            const titleIndex = headers.findIndex(h => h.includes('ã‚¿ã‚¤ãƒˆãƒ«'));
            const pageViewIndex = headers.findIndex(h => h.includes('ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼') && h.includes('åˆè¨ˆ'));
            const unitSessionRateIndex = headers.findIndex(h => h.includes('ãƒ¦ãƒ‹ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç‡'));
            const salesIndex = headers.findIndex(h => h.includes('æ³¨æ–‡å•†å“ã®å£²ä¸Šé¡'));
            const orderCountIndex = headers.findIndex(h => h.includes('æ³¨æ–‡ã•ã‚ŒãŸå•†å“ç‚¹æ•°'));
            let addedCount = 0;
            const parsedData = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = parseCSVLine(lines[i]);
                if (values.length < headers.length) continue;
                const asin = values[asinIndex] || '';
                const title = values[titleIndex] || '';
                const pageView = parseInt(values[pageViewIndex] || 0);
                const unitSessionRate = parseFloat((values[unitSessionRateIndex] || '0').replace('%', ''));
                const salesText = (values[salesIndex] || 'ï¿¥0').replace(/ï¿¥|,/g, '');
                const sales = parseInt(salesText || 0);
                const orderCount = parseInt(values[orderCountIndex] || 0);
                if (!asin) continue;
                const unitPrice = orderCount > 0 ? Math.round(sales / orderCount) : 0;
                const formattedProduct = {
                    date: dateStr,
                    mall: 'Amazon',
                    sku: asin,
                    name: title,
                    access: pageView,
                    sales: sales,
                    orders: orderCount,
                    cvr: unitSessionRate,
                    unitPrice: unitPrice
                };
                dailyData.push(formattedProduct);
                parsedData.push(formattedProduct);
                addedCount++;
            }
            showNotification(`âœ… ${addedCount}ä»¶ã®Amazonå•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆæ—¥ä»˜: ${dateStr}ï¼‰`);
            return { count: addedCount, data: parsedData, date: dateStr };
        }

        function updateDashboard() {
            const totalAccess = dailyData.reduce((sum, p) => sum + p.access, 0);
            const totalSales = dailyData.reduce((sum, p) => sum + p.sales, 0);
            const totalOrders = dailyData.reduce((sum, p) => sum + p.orders, 0);
            const avgCVR = totalAccess > 0 ? (totalOrders / totalAccess * 100) : 0;
            document.getElementById('totalAccess').textContent = totalAccess.toLocaleString();
            document.getElementById('totalSales').textContent = 'Â¥' + totalSales.toLocaleString();
            document.getElementById('totalOrders').textContent = totalOrders.toLocaleString();
            document.getElementById('avgCVR').textContent = avgCVR.toFixed(2) + '%';
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            if (dailyData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">ğŸ“‚</div><p>CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p></td></tr>`;
                return;
            }
            const sorted = [...dailyData].sort((a, b) => new Date(b.date) - new Date(a.date));
            tbody.innerHTML = sorted.map(p => `
                <tr>
                    <td>${p.date}</td>
                    <td><span class="mall-badge ${p.mall}">${p.mall}</span></td>
                    <td style="font-family: 'IBM Plex Mono', monospace; font-weight: 600;">${p.sku}</td>
                    <td>${p.name.substring(0, 50)}${p.name.length > 50 ? '...' : ''}</td>
                    <td>${p.access.toLocaleString()}</td>
                    <td>Â¥${p.sales.toLocaleString()}</td>
                    <td>${p.orders.toLocaleString()}</td>
                    <td>${p.cvr.toFixed(2)}%</td>
                </tr>
            `).join('');
        }

       // ========== æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ ==========
        let currentPeriodFilter = 'thisMonth';
        let customStartDate = null;
        let customEndDate = null;

        function setPeriodFilter(period, button) {
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            currentPeriodFilter = period;
            
            // ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜å…¥åŠ›ã®è¡¨ç¤º/éè¡¨ç¤º
            const customInputs = document.getElementById('customDateInputs');
            if (period === 'custom') {
                customInputs.classList.add('show');
            } else {
                customInputs.classList.remove('show');
                // æœŸé–“è¡¨ç¤ºã‚’æ›´æ–°
                updatePeriodDisplay();
                // ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°å†ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                if (currentTrendData && currentTrendData.length > 0) {
                    reloadWithFilter();
                }
            }
        }

        function applyCustomDateFilter() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate || !endDate) {
                showNotification('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„', true);
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showNotification('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„', true);
                return;
            }
            
            customStartDate = startDate;
            customEndDate = endDate;
            
            updatePeriodDisplay();
            
            // ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°å†ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            if (currentTrendData && currentTrendData.length > 0) {
                reloadWithFilter();
            }
        }

        function getDateRange() {
            const today = new Date();
            let startDate, endDate;
            
            switch (currentPeriodFilter) {
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'last2Months':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                case 'custom':
                    startDate = customStartDate ? new Date(customStartDate) : new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = customEndDate ? new Date(customEndDate) : today;
                    break;
                default:
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = today;
            }
            
            return { startDate, endDate };
        }

        function updatePeriodDisplay() {
            const { startDate, endDate } = getDateRange();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const startStr = startDate.toLocaleDateString('ja-JP', options);
            const endStr = endDate.toLocaleDateString('ja-JP', options);
            
            const display = document.getElementById('periodDisplay');
            if (display) {
                display.textContent = `è¡¨ç¤ºæœŸé–“: ${startStr} ã€œ ${endStr}`;
            }
        }

        function filterDataByPeriod(data) {
            const { startDate, endDate } = getDateRange();
            
            return data.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate >= startDate && itemDate <= endDate;
            });
        }

        function reloadWithFilter() {
            if (!currentSKU || !currentMall) return;
            
            // SKUã¨ãƒ¢ãƒ¼ãƒ«ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filtered = dailyData.filter(d => d.sku === currentSKU && d.mall === currentMall);
            
            // æœŸé–“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            filtered = filterDataByPeriod(filtered);
            
            if (filtered.length === 0) {
                showNotification('é¸æŠã—ãŸæœŸé–“ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', true);
                return;
            }
            
            filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const relevantActions = actionsData.filter(a => 
                a.sku === currentSKU && (a.mall === currentMall || a.mall === 'å…¨ã‚µã‚¤ãƒˆ')
            );
            
            // æœŸé–“ã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚‚ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const filteredActions = filterDataByPeriod(relevantActions);
            
            displayActions(filteredActions);
            renderCharts(filtered, filteredActions);
            renderTrendTable(filtered, filteredActions);
            
            showNotification(`âœ… ${filtered.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º`);
        }

        function initPeriodFilter() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            const startInput = document.getElementById('filterStartDate');
            const endInput = document.getElementById('filterEndDate');
            
            if (startInput) startInput.value = firstDay.toISOString().split('T')[0];
            if (endInput) endInput.value = today.toISOString().split('T')[0];
            
            updatePeriodDisplay();
        }

function loadTrendData() {
    const sku = document.getElementById('trendSKU').value.trim();
    const mall = document.getElementById('trendMall').value;
    
    if (!sku) {
        showNotification('SKUã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
        return;
    }
    
    // SKUã¨ãƒ¢ãƒ¼ãƒ«ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    let filtered = dailyData.filter(d => d.sku === sku && d.mall === mall);
    
    if (filtered.length === 0) {
        showNotification('è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', true);
        return;
    }
    
    // æœŸé–“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    filtered = filterDataByPeriod(filtered);
    
    if (filtered.length === 0) {
        showNotification('é¸æŠã—ãŸæœŸé–“ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœŸé–“ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„', true);
        return;
    }
    
    filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    const productName = filtered[0].name;
    currentTrendData = dailyData.filter(d => d.sku === sku && d.mall === mall); // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    currentProductName = productName;
    currentSKU = sku;
    currentMall = mall;
    
    const relevantActions = actionsData.filter(a => 
        a.sku === sku && (a.mall === mall || a.mall === 'å…¨ã‚µã‚¤ãƒˆ')
    );
    
    // æœŸé–“ã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚‚ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const filteredActions = filterDataByPeriod(relevantActions);
    
    displayActions(filteredActions);
    
    // å®‰å…¨ã«è¦ç´ ã‚’è¡¨ç¤º
    const viewToggle = document.getElementById('viewToggleContainer');
    const chart1 = document.getElementById('chartContainer');
    const chart2 = document.getElementById('chartContainer2');
    const chart3 = document.getElementById('chartContainer3');
    const table = document.getElementById('trendTableContainer');
    
    if (viewToggle) viewToggle.style.display = 'block';
    if (chart1) chart1.style.display = 'block';
    if (chart2) chart2.style.display = 'block';
    if (chart3) chart3.style.display = 'block';
    if (table) table.style.display = 'block';
    
    renderCharts(filtered, filteredActions);
    renderTrendTable(filtered, filteredActions);
    showNotification(`âœ… ${filtered.length}ä»¶ã®æ—¥æ¬¡æ¨ç§»ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
}
        function displayActions(actions) {
            const container = document.getElementById('productActions');
            
            if (actions.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            container.innerHTML = `
                <div class="search-section">
                    <h3 style="margin-bottom: 1rem;">ğŸ“Œ ã“ã®å•†å“ã®æ–½ç­–å±¥æ­´</h3>
                    ${actions.map(a => `
                        <div style="position: relative; padding: 0.5rem 1rem; margin: 0.5rem 0; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); border-left: 4px solid var(--warning); border-radius: 8px;">
                            <strong>${a.date}</strong> - ${a.category}: ${a.content}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderTrendTable(data, actions) {
            const tbody = document.getElementById('trendTableBody');
            document.getElementById('trendTableTitle').textContent = currentProductName;
            
            tbody.innerHTML = data.map(d => {
                const hasAction = actions.find(a => a.date === d.date);
                const actionStyle = hasAction ? 'background: rgba(245, 158, 11, 0.1);' : '';
                
                return `
                    <tr style="${actionStyle}">
                        <td>
                            ${d.date}
                            ${hasAction ? '<br><span style="display: inline-block; padding: 0.25rem 0.5rem; background: var(--warning); color: white; border-radius: 6px; font-size: 0.7rem;">ğŸ“Œ ' + hasAction.category + '</span>' : ''}
                        </td>
                        <td>${d.access.toLocaleString()}</td>
                        <td>Â¥${d.sales.toLocaleString()}</td>
                        <td>${d.orders.toLocaleString()}</td>
                        <td>${d.cvr.toFixed(2)}%</td>
                        <td>Â¥${d.unitPrice.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderCharts(data, actions) {
            const dates = data.map(d => d.date);
            const sales = data.map(d => d.sales);
            const cvr = data.map(d => d.cvr);
            const access = data.map(d => d.access);
            
            document.getElementById('chartProductName').textContent = currentProductName;
            
            const actionAnnotations = actions.map(action => ({
                type: 'line',
                xMin: action.date,
                xMax: action.date,
                borderColor: 'rgb(245, 158, 11)',
                borderWidth: 3,
                borderDash: [5, 5],
                label: {
                    content: `ğŸ“Œ ${action.category}`,
                    enabled: true,
                    position: 'start',
                    backgroundColor: 'rgb(245, 158, 11)',
                    color: 'white',
                    font: {
                        size: 11
                    }
                }
            }));
            
            if (salesChart) salesChart.destroy();
            salesChart = new Chart(document.getElementById('salesChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'å£²ä¸Šï¼ˆå††ï¼‰',
                        data: sales,
                        borderColor: 'rgb(6, 182, 212)',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'å£²ä¸Šæ¨ç§»',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { display: true }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            if (cvrChart) cvrChart.destroy();
            cvrChart = new Chart(document.getElementById('cvrChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'CVRï¼ˆ%ï¼‰',
                        data: cvr,
                        borderColor: 'rgb(16, 185, 129)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'CVRæ¨ç§»',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { display: true }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2) + '%';
                                }
                            }
                        }
                    }
                }
            });
            
            if (accessChart) accessChart.destroy();
            accessChart = new Chart(document.getElementById('accessChart'), {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'ã‚¢ã‚¯ã‚»ã‚¹æ•°',
                        data: access,
                        backgroundColor: 'rgba(99, 102, 241, 0.7)',
                        borderColor: 'rgb(99, 102, 241)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ã‚¢ã‚¯ã‚»ã‚¹æ•°æ¨ç§»',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: { display: true }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

function exportTrendData() {
    if (currentTrendData.length === 0) {
        showNotification('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', true);
        return;
    }
    
    const relevantActions = actionsData.filter(a => 
        a.sku === currentSKU && (a.mall === currentMall || a.mall === 'å…¨ã‚µã‚¤ãƒˆ')
    );
    
    const csv = [
        ['å•†å“å', currentProductName],
        ['SKU', currentSKU],
        ['ãƒ¢ãƒ¼ãƒ«', currentMall],
        [''],
        ['æ—¥ä»˜', 'ã‚¢ã‚¯ã‚»ã‚¹æ•°', 'å£²ä¸Š', 'æ³¨æ–‡æ•°', 'CVR(%)', 'å®¢å˜ä¾¡', 'æ–½ç­–ã‚«ãƒ†ã‚´ãƒª', 'æ–½ç­–å†…å®¹', 'æœŸå¾…åŠ¹æœ'],
        ...currentTrendData.map(d => {
            const action = relevantActions.find(a => a.date === d.date);
            return [
                d.date,
                d.access,
                d.sales,
                d.orders,
                d.cvr.toFixed(2),
                d.unitPrice,
                action ? action.category : '',
                action ? action.content : '',
                action ? action.expected : ''
            ];
        })
    ].map(row => row.join(',')).join('\n');
    
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `æ—¥æ¬¡æ¨ç§»_${currentSKU}_${currentMall}_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    
    showNotification('âœ… æ—¥æ¬¡æ¨ç§»ãƒ‡ãƒ¼ã‚¿ï¼ˆæ–½ç­–æƒ…å ±ä»˜ãï¼‰ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
}

        async function addAction() {
            const action = {
                date: document.getElementById('actionDate').value,
                mall: document.getElementById('actionMall').value,
                sku: document.getElementById('actionSKU').value,
                category: document.getElementById('actionCategory').value,
                content: document.getElementById('actionContent').value,
                expected: document.getElementById('actionExpected').value,
                id: Date.now(),
                createdBy: currentUserEmail
            };
            if (!action.date || !action.sku || !action.content) {
                showNotification('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }
            
            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${SHEET_NAME_ACTIONS}!A:H`,
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: [[
                            action.date,
                            action.mall,
                            action.sku,
                            action.category,
                            action.content,
                            action.expected,
                            action.createdBy,
                            new Date().toISOString()
                        ]]
                    }
                });
                showNotification('âœ… æ–½ç­–ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ï¼‰');
            } catch (err) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                showNotification('âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®æ›¸ãè¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
                return;
            }
            
            actionsData.push(action);
            updateActionsTable();
            document.getElementById('actionDate').value = '';
            document.getElementById('actionSKU').value = '';
            document.getElementById('actionContent').value = '';
            document.getElementById('actionExpected').value = '';
            await autoSync();
        }

 function updateActionsTable() {
    const tbody = document.getElementById('actionsTableBody');
    if (actionsData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>æ–½ç­–ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„</p></td></tr>`;
        return;
    }
    const sorted = [...actionsData].sort((a, b) => new Date(b.date) - new Date(a.date));
    tbody.innerHTML = sorted.map((action, index) => {
        const originalIndex = actionsData.findIndex(a => a.id === action.id);
        return `
            <tr>
                <td>${action.date}</td>
                <td><span class="mall-badge ${action.mall}">${action.mall}</span></td>
                <td style="font-family: 'IBM Plex Mono', monospace; font-weight: 600;">${action.sku}</td>
                <td><span style="display: inline-block; padding: 0.25rem 0.75rem; background: var(--warning); color: white; border-radius: 6px; font-size: 0.75rem; font-weight: 700;">${action.category}</span></td>
                <td>${action.content}</td>
                <td>${action.expected}</td>
                <td style="white-space: nowrap;">
                    <button class="delete-btn" onclick="showActionEffect(${originalIndex})" style="color: var(--success); margin-right: 0.5rem;" title="åŠ¹æœæ¸¬å®š">ğŸ“Š</button>
                    <button class="delete-btn" onclick="editAction(${originalIndex})" style="color: var(--accent); margin-right: 0.5rem;" title="ç·¨é›†">âœï¸</button>
                    <button class="delete-btn" onclick="deleteAction(${originalIndex})" title="å‰Šé™¤">ğŸ—‘ï¸</button>
                </td>
            </tr>
        `;
    }).join('');
}

let deleteTargetIndex = -1;
let editTargetIndex = -1;

function editAction(index) {
    editTargetIndex = index;
    const action = actionsData[index];
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    document.getElementById('editActionDate').value = action.date;
    document.getElementById('editActionMall').value = action.mall;
    document.getElementById('editActionSKU').value = action.sku;
    document.getElementById('editActionCategory').value = action.category;
    document.getElementById('editActionContent').value = action.content;
    document.getElementById('editActionExpected').value = action.expected;
    
    document.getElementById('editModal').classList.add('show');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
    editTargetIndex = -1;
}

async function confirmEdit() {
    if (editTargetIndex >= 0 && editTargetIndex < actionsData.length) {
        const updatedAction = {
            date: document.getElementById('editActionDate').value,
            mall: document.getElementById('editActionMall').value,
            sku: document.getElementById('editActionSKU').value,
            category: document.getElementById('editActionCategory').value,
            content: document.getElementById('editActionContent').value,
            expected: document.getElementById('editActionExpected').value,
            id: actionsData[editTargetIndex].id,
            createdBy: actionsData[editTargetIndex].createdBy
        };
        
        if (!updatedAction.date || !updatedAction.sku || !updatedAction.content) {
            showNotification('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
            return;
        }
        
        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°
        try {
            // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦å–å¾—
            const response = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: `${SHEET_NAME_ACTIONS}!A2:H`
            });
            
            const rows = response.result.values || [];
            
            // è©²å½“è¡Œã‚’è¦‹ã¤ã‘ã¦æ›´æ–°
            let rowIndex = -1;
            for (let i = 0; i < rows.length; i++) {
                if (rows[i][0] === actionsData[editTargetIndex].date &&
                    rows[i][2] === actionsData[editTargetIndex].sku &&
                    rows[i][4] === actionsData[editTargetIndex].content) {
                    rowIndex = i + 2; // +2 because: 1-indexed + header row
                    break;
                }
            }
            
            if (rowIndex > 0) {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${SHEET_NAME_ACTIONS}!A${rowIndex}:H${rowIndex}`,
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: [[
                            updatedAction.date,
                            updatedAction.mall,
                            updatedAction.sku,
                            updatedAction.category,
                            updatedAction.content,
                            updatedAction.expected,
                            updatedAction.createdBy,
                            new Date().toISOString()
                        ]]
                    }
                });
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                actionsData[editTargetIndex] = updatedAction;
                updateActionsTable();
                showNotification('âœ… æ–½ç­–è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                closeEditModal();
            } else {
                showNotification('âŒ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', true);
            }
        } catch (err) {
            console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
            showNotification('âŒ æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
        }
    }
}

function deleteAction(index) {
    deleteTargetIndex = index;
    document.getElementById('deleteModal').classList.add('show');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('show');
    deleteTargetIndex = -1;
}

async function confirmDelete() {
    if (deleteTargetIndex >= 0 && deleteTargetIndex < actionsData.length) {
        actionsData.splice(deleteTargetIndex, 1);
        updateActionsTable();
        showNotification('âœ… æ–½ç­–è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        closeDeleteModal();
        await autoSync();
    }
}

function showActionEffect(index) {
    const action = actionsData[index];
    
    // è©²å½“ã™ã‚‹SKUã¨ãƒ¢ãƒ¼ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    const relatedData = dailyData.filter(d => 
        d.sku === action.sku && d.mall === action.mall
    ).sort((a, b) => new Date(a.date) - new Date(b.date));
    
    if (relatedData.length < 14) {
        showNotification('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆå‰å¾Œ7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™ï¼‰', true);
        return;
    }
    
    const actionDate = new Date(action.date);
    
    // å‰7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿
    const beforeData = relatedData.filter(d => {
        const date = new Date(d.date);
        const diffDays = Math.floor((actionDate - date) / (1000 * 60 * 60 * 24));
        return diffDays > 0 && diffDays <= 7;
    });
    
    // å¾Œ7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿
    const afterData = relatedData.filter(d => {
        const date = new Date(d.date);
        const diffDays = Math.floor((date - actionDate) / (1000 * 60 * 60 * 24));
        return diffDays > 0 && diffDays <= 7;
    });
    
    if (beforeData.length === 0 || afterData.length === 0) {
        showNotification('âš ï¸ æ–½ç­–å‰å¾Œã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', true);
        return;
    }
    
    // å¹³å‡å€¤ã‚’è¨ˆç®—
    const calcAverage = (data, key) => {
        const sum = data.reduce((acc, d) => acc + d[key], 0);
        return sum / data.length;
    };
    
    const beforeAvg = {
        access: calcAverage(beforeData, 'access'),
        sales: calcAverage(beforeData, 'sales'),
        orders: calcAverage(beforeData, 'orders'),
        cvr: calcAverage(beforeData, 'cvr')
    };
    
    const afterAvg = {
        access: calcAverage(afterData, 'access'),
        sales: calcAverage(afterData, 'sales'),
        orders: calcAverage(afterData, 'orders'),
        cvr: calcAverage(afterData, 'cvr')
    };
    
    // å¤‰åŒ–ç‡ã‚’è¨ˆç®—
    const calcChange = (before, after) => {
        if (before === 0) return after > 0 ? 100 : 0;
        return ((after - before) / before) * 100;
    };
    
    const changes = {
        access: calcChange(beforeAvg.access, afterAvg.access),
        sales: calcChange(beforeAvg.sales, afterAvg.sales),
        orders: calcChange(beforeAvg.orders, afterAvg.orders),
        cvr: calcChange(beforeAvg.cvr, afterAvg.cvr)
    };
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤º
    displayEffectModal(action, beforeAvg, afterAvg, changes, relatedData);
}

function displayEffectModal(action, beforeAvg, afterAvg, changes, allData) {
    const formatNumber = (num) => Math.round(num).toLocaleString();
    const formatChange = (change) => {
        const arrow = change > 0 ? 'â†‘' : change < 0 ? 'â†“' : 'â†’';
        const color = change > 0 ? 'var(--success)' : change < 0 ? 'var(--danger)' : 'var(--text-muted)';
        return `<span style="color: ${color}; font-weight: 700;">${change > 0 ? '+' : ''}${change.toFixed(1)}% ${arrow}</span>`;
    };
    
    const modalContent = `
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg); border-radius: 8px;">
            <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">æ–½ç­–æƒ…å ±</div>
            <div style="font-weight: 700; margin-bottom: 0.25rem;">${action.date} | ${action.mall} | ${action.sku}</div>
            <div style="font-size: 0.875rem;">${action.content}</div>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <h4 style="margin-bottom: 1rem; color: var(--accent);">ğŸ“Š å‰å¾Œæ¯”è¼ƒï¼ˆ7æ—¥é–“å¹³å‡ï¼‰</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: var(--bg);">
                        <th style="padding: 0.75rem; text-align: left; font-weight: 600;">æŒ‡æ¨™</th>
                        <th style="padding: 0.75rem; text-align: right;">æ–½ç­–å‰</th>
                        <th style="padding: 0.75rem; text-align: right;">æ–½ç­–å¾Œ</th>
                        <th style="padding: 0.75rem; text-align: right;">å¤‰åŒ–ç‡</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem; font-weight: 600;">ã‚¢ã‚¯ã‚»ã‚¹æ•°</td>
                        <td style="padding: 0.75rem; text-align: right;">${formatNumber(beforeAvg.access)}</td>
                        <td style="padding: 0.75rem; text-align: right;">${formatNumber(afterAvg.access)}</td>
                        <td style="padding: 0.75rem; text-align: right;">${formatChange(changes.access)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem; font-weight: 600;">å£²ä¸Š</td>
                        <td style="padding: 0.75rem; text-align: right;">Â¥${formatNumber(beforeAvg.sales)}</td>
                        <td style="padding: 0.75rem; text-align: right;">Â¥${formatNumber(afterAvg.sales)}</td>
                        <td style="padding: 0.75rem; text-align: right;">${formatChange(changes.sales)}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem; font-weight: 600;">æ³¨æ–‡æ•°</td>
                        <td style="padding: 0.75rem; text-align: right;">${formatNumber(beforeAvg.orders)}</td>
                        <td style="padding: 0.75rem; text-align: right;">${formatNumber(afterAvg.orders)}</td>
                        <td style="padding: 0.75rem; text-align: right;">${formatChange(changes.orders)}</td>
                    </tr>
                    <tr>
                        <td style="padding: 0.75rem; font-weight: 600;">CVR</td>
                        <td style="padding: 0.75rem; text-align: right;">${beforeAvg.cvr.toFixed(2)}%</td>
                        <td style="padding: 0.75rem; text-align: right;">${afterAvg.cvr.toFixed(2)}%</td>
                        <td style="padding: 0.75rem; text-align: right;">${formatChange(changes.cvr)}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div id="effectChartContainer" style="margin-top: 1.5rem;">
            <canvas id="effectChart" height="300"></canvas>
        </div>
    `;
    
    document.getElementById('effectModalContent').innerHTML = modalContent;
    document.getElementById('effectModal').classList.add('show');
    
    // ã‚°ãƒ©ãƒ•ã‚’æç”»
    setTimeout(() => drawEffectChart(action, allData), 100);
}

function drawEffectChart(action, data) {
    const ctx = document.getElementById('effectChart');
    if (!ctx) return;
    
    const chartData = data.map(d => ({
        x: d.date,
        y: d.cvr
    }));
    
    if (window.effectChartInstance) {
        window.effectChartInstance.destroy();
    }
    
    window.effectChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: 'CVR (%)',
                data: chartData,
                borderColor: 'rgb(6, 182, 212)',
                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                borderWidth: 3,
                pointRadius: 4,
                pointHoverRadius: 6,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true
                },
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line',
                            xMin: action.date,
                            xMax: action.date,
                            borderColor: 'rgb(239, 68, 68)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                content: 'æ–½ç­–å®Ÿæ–½æ—¥',
                                enabled: true,
                                position: 'top'
                            }
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                        displayFormats: {
                            day: 'MM/DD'
                        }
                    },
                    title: {
                        display: true,
                        text: 'æ—¥ä»˜'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'CVR (%)'
                    }
                }
            }
        }
    });
}

function closeEffectModal() {
    document.getElementById('effectModal').classList.remove('show');
    if (window.effectChartInstance) {
        window.effectChartInstance.destroy();
    }
}

async function confirmDelete() {
    if (deleteTargetIndex >= 0 && deleteTargetIndex < actionsData.length) {
        actionsData.splice(deleteTargetIndex, 1);
        updateActionsTable();
        showNotification('âœ… æ–½ç­–è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        closeDeleteModal();
        await autoSync();
    }
}

        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            let className = 'notification show';
            if (isError) {
                className += ' error';
            }
            notification.className = className;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        function openSettingsModal() {
            const config = getConfig();
            if (config) {
                document.getElementById('settingsApiKey').value = config.API_KEY || '';
                document.getElementById('settingsClientId').value = config.CLIENT_ID || '';
                document.getElementById('settingsSpreadsheetId').value = config.SPREADSHEET_ID || '';
            }
            document.getElementById('settingsModal').classList.add('show');
        }

        function closeSettingsModal() {
            // åˆå›è¨­å®šã®å ´åˆã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸å¯
            if (!getConfig()) {
                showNotification('âš ï¸ è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„', true);
                return;
            }
            document.getElementById('settingsModal').classList.remove('show');
        }

        function saveSettings() {
            const apiKey = document.getElementById('settingsApiKey').value.trim();
            const clientId = document.getElementById('settingsClientId').value.trim();
            const spreadsheetId = document.getElementById('settingsSpreadsheetId').value.trim();

            if (!apiKey || !clientId || !spreadsheetId) {
                showNotification('âš ï¸ ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }

            // è¨­å®šã‚’ä¿å­˜
            saveConfig(apiKey, clientId, spreadsheetId);
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
            API_KEY = apiKey;
            CLIENT_ID = clientId;
            SPREADSHEET_ID = spreadsheetId;

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.getElementById('settingsModal').classList.remove('show');
            
            showNotification('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...');
            
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        function exportSettings() {
            const config = getConfig();
            if (!config) {
                showNotification('âš ï¸ è¨­å®šãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“', true);
                return;
            }

            const dataStr = JSON.stringify(config, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ec-dashboard-settings.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('âœ… è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }

        function importSettings(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    if (config.API_KEY && config.CLIENT_ID && config.SPREADSHEET_ID) {
                        document.getElementById('settingsApiKey').value = config.API_KEY;
                        document.getElementById('settingsClientId').value = config.CLIENT_ID;
                        document.getElementById('settingsSpreadsheetId').value = config.SPREADSHEET_ID;
                        showNotification('âœ… è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
                    } else {
                        showNotification('âš ï¸ ç„¡åŠ¹ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã™', true);
                    }
                } catch (err) {
                    showNotification('âš ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®åˆæœŸåŒ–
            initPeriodFilter();
            
            // è¨­å®šãƒã‚§ãƒƒã‚¯
            const config = getConfig();
            if (!config || !config.API_KEY || !config.CLIENT_ID || !config.SPREADSHEET_ID) {
                // åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                document.getElementById('settingsCancelBtn').style.display = 'none';
                openSettingsModal();
            } else {
                // è¨­å®šæ¸ˆã¿ã®å ´åˆã¯é€šå¸¸èµ·å‹•
                if (API_KEY && CLIENT_ID) {
                    gapiLoaded();
                    gisLoaded();
                }
            }
        });
    </script>
    
    <!-- Effect Measurement Modal -->
    <div class="modal-overlay" id="effectModal">
        <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h3 class="modal-title">ğŸ“Š æ–½ç­–åŠ¹æœæ¸¬å®š</h3>
            <div class="modal-content" id="effectModalContent">
                <!-- å‹•çš„ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>
            <div style="display: flex; justify-content: center; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="closeEffectModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal" style="max-width: 600px;">
            <h3 class="modal-title">âœï¸ æ–½ç­–è¨˜éŒ²ã‚’ç·¨é›†</h3>
            <div class="modal-content">
                <div class="form-group">
                    <label class="form-label">å®Ÿæ–½æ—¥ *</label>
                    <input type="date" id="editActionDate" class="search-input">
                </div>
                <div class="form-group">
                    <label class="form-label">ãƒ¢ãƒ¼ãƒ« *</label>
                    <select id="editActionMall" class="search-input">
                        <option value="æ¥½å¤©">æ¥½å¤©</option>
                        <option value="Yahoo">Yahoo</option>
                        <option value="Amazon">Amazon</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">SKU *</label>
                    <input type="text" id="editActionSKU" class="search-input" placeholder="ä¾‹: 213-62">
                </div>
                <div class="form-group">
                    <label class="form-label">æ–½ç­–ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="editActionCategory" class="search-input">
                        <option value="ç”»åƒæ”¹å–„">ç”»åƒæ”¹å–„</option>
                        <option value="ä¾¡æ ¼å¤‰æ›´">ä¾¡æ ¼å¤‰æ›´</option>
                        <option value="åºƒå‘Šæ–½ç­–">åºƒå‘Šæ–½ç­–</option>
                        <option value="ã‚¯ãƒ¼ãƒãƒ³é…å¸ƒ">ã‚¯ãƒ¼ãƒãƒ³é…å¸ƒ</option>
                        <option value="å•†å“èª¬æ˜æ”¹å–„">å•†å“èª¬æ˜æ”¹å–„</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æ–½ç­–å†…å®¹ *</label>
                    <textarea id="editActionContent" class="search-input" rows="3" placeholder="å…·ä½“çš„ãªæ–½ç­–å†…å®¹ã‚’è¨˜å…¥"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">æœŸå¾…åŠ¹æœ</label>
                    <input type="text" id="editActionExpected" class="search-input" placeholder="ä¾‹: CVR 0.5%å‘ä¸Š">
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="closeEditModal()" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn" onclick="confirmEdit()" style="flex: 1;">æ›´æ–°</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="max-width: 600px;">
            <h3 class="modal-title">âš™ï¸ åˆæœŸè¨­å®š</h3>
            <div class="modal-content">
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                    ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Google Cloud Consoleã§å–å¾—ã—ãŸèªè¨¼æƒ…å ±ãŒå¿…è¦ã§ã™ã€‚<br>
                    è¨­å®šã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«å®‰å…¨ã«ä¿å­˜ã•ã‚Œã€ä»–ã®äººã«ã¯è¦‹ãˆã¾ã›ã‚“ã€‚
                </p>
                
                <div class="form-group">
                    <label class="form-label">APIã‚­ãƒ¼ *</label>
                    <input type="text" id="settingsApiKey" class="search-input" placeholder="AIzaSy...">
                    <small style="color: var(--text-muted);">Google Cloud Console â†’ èªè¨¼æƒ…å ± â†’ APIã‚­ãƒ¼</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">OAuth 2.0 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID *</label>
                    <input type="text" id="settingsClientId" class="search-input" placeholder="1234567890-...apps.googleusercontent.com">
                    <small style="color: var(--text-muted);">Google Cloud Console â†’ èªè¨¼æƒ…å ± â†’ OAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID *</label>
                    <input type="text" id="settingsSpreadsheetId" class="search-input" placeholder="1oIA-Odng0UiXYjD7...">
                    <small style="color: var(--text-muted);">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URL: .../d/{ID}/edit</small>
                </div>
                
                <div style="margin-top: 2rem; padding: 1rem; background: var(--bg); border-radius: 8px;">
                    <h4 style="margin-bottom: 0.5rem; font-size: 0.875rem;">ğŸ’¾ è¨­å®šã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h4>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary" onclick="exportSettings()" style="flex: 1; font-size: 0.875rem;">
                            ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importSettingsFile').click()" style="flex: 1; font-size: 0.875rem;">
                            ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                    <input type="file" id="importSettingsFile" accept=".json" style="display: none;" onchange="importSettings(event)">
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="closeSettingsModal()" style="flex: 1;" id="settingsCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn" onclick="saveSettings()" style="flex: 1;">ä¿å­˜ã—ã¦é–‹å§‹</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <h3 class="modal-title">ğŸ—‘ï¸ æ–½ç­–è¨˜éŒ²ã‚’å‰Šé™¤</h3>
            <div class="modal-content">
                <p>ã“ã®æ–½ç­–è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?</p>
                <p style="color: var(--text-muted); font-size: 0.875rem;">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()" style="flex: 1;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn" onclick="confirmDelete()" style="flex: 1; background: var(--danger);">å‰Šé™¤</button>
            </div>
        </div>
    </div>
</body>
</html>
